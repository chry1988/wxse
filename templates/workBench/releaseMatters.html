{% extends "mainHtml.html" %}
{% block customermodle %}


    <!-- Modal -->
    <div class="modal fade " id="myModalrelease" data-bs-backdrop="static" data-bs-keyboard="false"
         tabindex="-1"
         aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="staticBackdropLabel">进度情况</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form class="row g-3">
                        {% csrf_token %}
                        <div class="row g-3 align-items-center">
                            <div class="col-auto">
                                <label for="vulnerabilityName" class="col-form-label">漏洞名称</label>
                            </div>
                            <div class="col-auto">
                                <input type="text" id="vulnerabilityName" class="form-control">
                            </div>
                            <div class="col-auto">
                                <label for="vulnerabilityDtime" class="col-form-label">截止时间</label>
                            </div>
                            <div class="col-auto">
                                <input type="text" class="form-control" id="vulnerabilityDtime" placeholder="">
                            </div>
                        </div>
                        <div class="row g-3 align-items-center">
                            <div class="col-auto">
                                <label for="CVEserialNumber" class="col-form-label">CVE编号</label>
                            </div>
                            <div class="col-auto">
                                <input type="text" class="form-control" id="CVEserialNumber" placeholder="CVE编号"
                                       required>
                            </div>
                            <div class="col-auto">
                                <label for="CNNVDserialNumber" class="col-form-label">CNNVD编号</label>
                            </div>
                            <div class="col-auto">
                                <input type="text" class="form-control" id="CNNVDserialNumber" placeholder="CNNVD编号"
                                       required>
                            </div>
                            <div class="col-auto">
                                <label for="vulnerabilityLevel" class="col-form-label">严重级别</label>
                            </div>
                            <div class="col-auto">
                                <select class="form-select" aria-label="Default select example" id="vulnerabilityLevel">
                                    <option selected disabled value="">请选择漏洞级别</option>
                                    <option value="0">高危漏洞</option>
                                    <option value="1">中危漏洞</option>
                                    <option value="2">低危漏洞</option>
                                </select>
                            </div>
                        </div>
                        <div class="row g-3 align-items-center">
                            <div class="col-auto">
                                <label for="vulnerabilityDetail" class="col-form-label">描述</label>
                            </div>
                            <div class="col-auto">
                                <input type="text" class="form-control" id="vulnerabilityDetail" placeholder="描述"
                                       required>
                            </div>
                        </div>
                        <div class="row g-3 align-items-center">
                            <div class="col-auto">
                                <label for="vulnerabilityrepairMethod" class="col-form-label">修复方式</label>
                            </div>
                            <div class="col-auto">
                                <textarea type="text" class="form-control" id="vulnerabilityrepairMethod"
                                          rows="3"></textarea>
                            </div>

                        </div>
                        <div class="row g-3 align-items-center">
                            <div class="col-auto">
                                <label for="affectedStaff" class="col-form-label">关联人员</label>
                            </div>
                            <div class="col-auto">
                                {% for users in userList %}
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="{{ users.id }}"
                                               id="{{ users.id }}">
                                        <label class="form-check-label" for="{{ users.id }}">
                                            {{ users.last_name }}
                                        </label>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="row g-3 align-items-center">
                            <div class="col-auto">
                                <label for="affectedServie" class="col-form-label">影响业务</label>
                            </div>
                            <div class="col-auto">
                                <input type="text" class="form-control" id="affectedServie" placeholder="影响业务" required>
                            </div>
                        </div>

                    </form>
                </div>
                <div class="modal-footer">
                    <div class="col-auto">
                        <button id="releaseMattersAdd" class="btn btn-primary" type="submit" data-bs-dismiss="modal">
                            新增
                        </button>
                    </div>
                    {#                    <button type="button" class="btn btn-primary">Understood</button>#}
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block content %}
    <div class="container-fluid">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="#">url1</a></li>
                <li class="breadcrumb-item"><a href="#">url2</a></li>
                <li class="breadcrumb-item active" aria-current="page">url3</li>
            </ol>
        </nav>
    </div>
    <button type="button" class="btn btn-primary" data-bs-toggle="modal"
            data-bs-target="#myModalrelease" data-wid="{{ item.id }}">
        新增
    </button>
    <table class="table table-striped table-hover">
        <thead>
        <tr>
            <th scope="col">#</th>
            <th scope="col">漏洞编号</th>
            <th scope="col">漏洞名称</th>
            <th scope="col">影响业务</th>
            <th scope="col">漏洞级别</th>
            <th scope="col">IP地址</th>
            <th scope="col">IP端口</th>
            <th scope="col">联系人</th>
            <th scope="col">操作</th>
        </tr>
        </thead>
        <tbody>
        {% for item in waitToReleaseMattersPage %}
            <tr>
                <th scope="row">{{ forloop.counter }}</th>
                <td>{{ item.vulnerability__id }}</td>
                <td>{{ item.vulnerability__name }}</td>
                 <td>{{ item.affectedServie }}</td>
                 <td>{{ item.vulnerability__level }}</td>
                <td>{{ item.taskUser__last_name }}{{ item.taskUser__first_name }}</td>
                <td>{{ item.deadLine }}</td>

                <td>
                    <div class="btn-group" role="group" aria-label="Basic example">
                        <button type="button" class="btn btn-warning" data-bs-toggle="modal"
                                data-bs-target="#myModalrelease" data-tid="{{ item.id }}" data-modify="change">查看任务
                        </button>
                        <button type="button" class="btn btn-primary" data-tid="{{ item.id }}" data-modify="release">
                            下发任务
                        </button>
                        <button type="button" class="btn btn-danger" data-tid="{{ item.id }}" data-modify="delete">
                            删除任务
                        </button>
                    </div>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
    <nav aria-label="...">
        <ul class="pagination">
            <li class="page-item">
                <a class="page-link" href="?page=1" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a>
            </li>
            <li class="page-item">
                {% if waitToReleaseMattersPage.has_previous %}
                    <a class="page-link" href="?page={{ waitToReleaseMattersPage.previous_page_number }}">previous</a>
                {% endif %}
            </li>
            <li class="page-item"><a class="page-link"
                                     href="?page={{ waitToReleaseMattersPage.number }}">{{ waitToReleaseMattersPage.number }}</a>
            </li>
            {% if waitToReleaseMattersPage.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ waitToReleaseMattersPage.next_page_number }}">next</a>
                </li>
            {% endif %}
            <li class="page-item">
                <a class="page-link" href="?page={{ waitToReleaseMattersPage.paginator.num_pages }}"><span
                        aria-hidden="true">&raquo;</span></a>
            </li>
        </ul>
    </nav>
{% endblock %}
{% block customerjs %}
    <script type="text/javascript">
        $(document).ready(function () {
            $('#vulnerabilityDtime').datetimepicker({
                forceParse: 0,
                format: 'yyyy-mm-dd hh:mm:ss',
                language: 'zh-CN',
                pickTime: false,
                initialDate: new Date(),
                todayBtn: true,
            });
            var myModal = document.getElementById('myModalrelease')
            var myInput = document.getElementById('myInput')
            $("#releaseMattersAdd").click(function () {
                {#var csrftoken = jQuery("[name=csrfmiddlewaretoken]").val();#}
                var vulnerabilityName = $("#vulnerabilityName").val();
                var vulnerabilityDtime = $("#vulnerabilityDtime").val();
                var CVEserialNumber = $("#CVEserialNumber").val();
                var CNNVDserialNumber = $("#CNNVDserialNumber").val();
                var vulnerabilityLevel = $("#vulnerabilityLevel").val();
                var vulnerabilityrepairMethod = $("#vulnerabilityrepairMethod").val();
                var vulnerabilityDetail = $("#vulnerabilityDetail").val();
                var affectedServie = $("#affectedServie").val();
                var uids = '';
                $("input[type='checkbox']").each(function () {
                    //$("input:checkbox").each(function () {
                    if ($(this).prop("checked") == true) {
                        uids += $(this).val() + ',';
                    }
                });
                data = {

                    vulnerabilityName: vulnerabilityName,
                    vulnerabilityDtime: vulnerabilityDtime,
                    CVEserialNumber: CVEserialNumber,
                    CNNVDserialNumber: CNNVDserialNumber,
                    vulnerabilityLevel: vulnerabilityLevel,
                    vulnerabilityrepairMethod: vulnerabilityrepairMethod,
                    affectedServie: affectedServie,
                    vulnerabilityDetail: vulnerabilityDetail,
                    uids: uids,
                };
                $.post("/workbench/releasematters", data, function (result) {
                })
            });

            //
            $("td button").click(function () {
                var tid = $(this).data("tid");
                var modify = $(this).data("modify");
                var csrftoken = jQuery("[name=csrfmiddlewaretoken]").val();

                if (modify == 'delete') {
                    data = {
                        csrfmiddlewaretoken: csrftoken,
                        tid: tid,
                        modify: 'delete',
                    };
                    $.post("/workbench/releasematters/delete", data, function (result) {
                            var jsonarray = $.parseJSON(result);
                            var targetwid = "button[data-tid=" + jsonarray["tid"] + "]";
                            $(targetwid).parent().parent().parent().remove();
                        }
                    );
                } else if (modify == 'release') {
                    data = {
                        csrfmiddlewaretoken: csrftoken,
                        tid: tid,
                        modify: 'release',
                    };
                    $.post("/workbench/releasematters/release", data, function (result) {
                            var jsonarray = $.parseJSON(result);
                            var targetwid = "button[data-tid=" + jsonarray["tid"] + "]";
                            $(targetwid).parent().parent().parent().remove();
                        }
                    );
                } else if (modify == 'change') {
                    data = {
                        csrfmiddlewaretoken: csrftoken,
                        tid: tid,
                        modify: 'get',
                    };
                    $.get("/workbench/releasematters/getdetil", data, function (result) {

                            var jsonarray = $.parseJSON(result);


                            $("#mtitle").text(jsonarray['queryresult'][0]['programName']);
                            $("#programName").val(jsonarray['queryresult'][0]['programName']);
                            $("#startDate").val(jsonarray['queryresult'][0]['startDate']);
                            $("#endDate").val(jsonarray['queryresult'][0]['endDate']);
                            $("#inPutStream").val(jsonarray['queryresult'][0]['inPutStream']);
                            $("#inPutStreamSub").val(jsonarray['queryresult'][0]['inPutStreamSub']);
                            $("#adminStaff").val(jsonarray['queryresult'][0]['adminStaff']);
                            $("#notes").val(jsonarray['queryresult'][0]['notes']);

                            var programChannel = jsonarray['queryresult'][0]['programChannel'];
                            $("#programChannel option").each(function () {
                                if ($(this).text() == programChannel) {
                                    $(this).prop("selected", 'selected');
                                }
                            });


                            var isLive = jsonarray['queryresult'][0]['isLive'];
                            if (isLive == true) {
                                $("#isLive").prop('checked', 'true');
                                $("#isLive").val('true');
                            }
                            var isRecode = jsonarray['queryresult'][0]['isRecode'];
                            if (isRecode == true) {
                                $("#isRecode").prop('checked', 'true');
                                $("#isRecode").val('true');
                            }
                            var adminStafflist = jsonarray['staffquery'];
                            var adminStaff = jsonarray['queryresult'][0]['adminStaff'];
                            if ($("#adminStaff option").length == 0) {
                                for (i in adminStafflist) {
                                    if (adminStafflist[i]['id'] == adminStaff) {
                                        $("#adminStaff").append("<option value=" + adminStafflist[i]['id'] + " selected>" + adminStafflist[i]['staffName'] + "</option>");
                                    } else {
                                        $("#adminStaff").append("<option value=" + adminStafflist[i]['id'] + ">" + adminStafflist[i]['staffName'] + "</option>");
                                    }

                                }
                            }
                            //$("#adminStaff option").each(function () {
                            //   if ($(this).text() == adminStaff) {
                            //     $(this).prop("selected", 'selected');
                            //  }
                            // });


                            $("button[data-modify='postchange']").attr('data-wid', wid);
                            $("button[data-modify='postchange']").attr('data-tid', tid);

                        }
                    );
                } else if (modify == 'postchange') {
                    var programName = $("#programName").val();
                    var startDate = $("#startDate").val();
                    var endDate = $("#endDate").val();
                    var inPutStream = $("#inPutStream").val();
                    var inPutStreamSub = $("#inPutStreamSub").val();
                    var notes = $("#notes").val();
                    var programChannel = $("#programChannel").val();
                    var isLive = $("#isLive").is(':checked');
                    var isRecode = $("#isRecode").is(':checked');
                    var adminStaff = $("#adminStaff").val();

                    postdata = {
                        csrfmiddlewaretoken: csrftoken,
                        tid: tid,
                        wid: wid,
                        programName: programName,
                        startDate: startDate,
                        endDate: endDate,
                        inPutStream: inPutStream,
                        inPutStreamSub: inPutStreamSub,
                        notes: notes,
                        programChannel: programChannel,
                        isLive: isLive,
                        isRecode: isRecode,
                        adminStaff: adminStaff,
                        modify: 'change',
                    }
                    ;
                    $.post("/workbench/releasematters/change", postdata, function (result) {
                        if (result == 'success') {
                            window.location.reload()
                        } else if (result == 'error') {
                            alert(result)
                        }
                    })
                }
            });
            //
        })
    </script>
{% endblock %}